with customer_orders as (
	
	select 
	cu.customer_id
	, cu.customer_city
	, o.order_id
	, o.order_purchase_timestamp
	from customers as cu
	left join orders as o
	on cu.customer_id = o.customer_id
	)

, order_metrics as (
	
	select 
	o.customer_id
	, o.order_id
	, sum(oi.price::numeric + oi.freight_value::numeric) as total_order_value
	, round(sum(oi.price::numeric + oi.freight_value::numeric) / count(o.order_id), 2) as average_order_value
	, sum(oi.price::numeric) as total_spend
	, count(o.order_id) as total_number_of_orders
	from orders as o
	left join order_items as oi
	on o.order_id = oi.order_id
	group by 1,2

)

, day_of_highest_purchase as (
	
	select
	o.customer_id
	, to_char(o.order_purchase_timestamp::date, 'day') as day_of_week
	, total_spend as total_spend_per_customer
	, rank() over (partition by to_char(o.order_purchase_timestamp::date, 'day') order by total_spend desc) as day_rank
	from customer_orders as o
	left join order_metrics as om
	on om.order_id = o.order_id
	where total_spend is not null
	)
	--select * from day_of_highest_purchase
, third_order_value as (
    SELECT
        customer_id,
        COALESCE(MAX(CASE WHEN row_num = 3 THEN total_order_value END), 0) AS third_order_value
    FROM (SELECT
            om.customer_id,
            total_order_value,
		  
            count(co.order_id) over (partition by co.order_purchase_timestamp order by co.order_purchase_timestamp::timestamp) AS row_num
        FROM order_metrics as om
		left join customer_orders as co
		on co.customer_id = om.customer_id
    ) sub
    GROUP BY customer_id
	
	)

, finals as (
	
	SELECT
    co.customer_id,
    co.customer_city,
    om.average_order_value,
    om.total_spend as total_spend_per_customer,
    om.total_number_of_orders,
    dhp.day_of_week AS day_of_week_with_highest_purchase,
    tov.third_order_value
	FROM customer_orders co
	left JOIN order_metrics as om 
	on co.customer_id = om.customer_id
	inner join day_of_highest_purchase as dhp 
	on co.customer_id = dhp.customer_id AND dhp.day_rank = 1
	inner JOIN third_order_value tov ON co.customer_id = tov.customer_id
	ORDER BY co.customer_id

)
select * from finals
